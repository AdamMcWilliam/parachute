const e="https://api.pixelplush.dev/v1";let t="Pixel Avalanche",a={},o={},n="",r=1920,s=1080,i=.5;function l(e){return Math.floor(Math.random()*Math.floor(e))}window.setupGame=function(e,l,c){t=e,a=l,o=c,n=a.path||"",o.clouds=void 0===o.clouds||null===o.clouds?!o.overlay:o.clouds,i=void 0===o.volume||null===o.volume?0:parseInt(o.volume)/100,r=Math.min(window.innerWidth,1920),s=Math.min(window.innerHeight,1080)},window.WebFontConfig={custom:{families:["Pixeltype"]},active(){!async function(){if(document.hidden)return void document.addEventListener("visibilitychange",()=>{location.reload()},!1);try{const e=(await fetch(`${n}/assets/shamelist.txt`).then(e=>e.text())).split(",").map(e=>e.trim().toLowerCase());o.channel&&e&&e.includes(o.channel.toLowerCase())&&(console.log("This channel has been blocked for violating the PixelPlush Terms of Service."),p=!1)}catch(e){console.log(e)}Unicorn.Create("unicorn-display",{width:r,height:s,background:"transparent",init:B,update:F,channel:o.channel,username:o.oauth?o.channel:void 0,password:o.oauth,onCommand:u,onChat:g,screenWalls:!1,gravity:{x:0,y:1}}),ComfyJS.onCheer=x,ComfyJS.onConnected=async(e,t,n)=>{if(n){!function(){if(_=a.target_width||368,$=_/2+.8*r,U=s-47+(a.target_offset||0),Array.isArray(a.target)){A=0,S=[];for(let e=0;e<a.target.length;e++){let t=Unicorn.AddBacklay("target"+e,"target"+e,$,U,{scale:{x:2,y:2}});t.zIndex=10,t.anchor.set(.5),t.visible=!1,S.push(t)}S[A].visible=!0,o.hideTilDrop||setInterval(()=>{S[A].visible=!1,A=(A+1)%S.length,S[A].visible=!0},60)}else S=Unicorn.AddBacklay("target","target",$,U,{scale:{x:2,y:2}}),S.zIndex=10,S.anchor.set(.5);a.target_front&&(I=Unicorn.AddOverlay("target_front","target_front",$,U,{scale:{x:2,y:2}}),I.anchor.set(.5));if(o.clouds)for(let e=0;e<11;e++){f++;let e=a.clouds[l(a.clouds.length)],t=Unicorn.AddOverlay("cloud_"+f,e,l(r),l(500),{scale:{x:3,y:3}});t.alpha=o.overlay?.5:.9,t.anchor.set(.5),t.speed=.01+.1*Math.random(),t.zIndex=t.speed,P.push(t)}o.hideTilDrop&&(P.forEach(e=>e.visible=!1),Array.isArray(a.target)?S.forEach(e=>{e.visible=!1}):S.visible=!1,I.visible=!1)}();let e=await d();0!==e&&(c=e.session,setInterval(()=>{d()},6e4))}}}()}},function(){const e=document.createElement("script");e.src=`${"https:"===document.location.protocol?"https":"http"}://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js`,e.type="text/javascript",e.async="true";const t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}();var c="",p=!0;async function d(){let a=Object.keys(L).length;return fetch(`${e}/analytics/heartbeat`,{method:"POST",body:JSON.stringify({session:c,game:"rolling",theme:t,channel:o.channel,players:Object.keys(L),count:a})}).then(e=>e.json())}async function h(a,n,r,s){return o.oauth?fetch(`${e}/scores/add`,{method:"POST",body:JSON.stringify({token:o.oauth.replace("oauth:",""),channel:o.channel,game:"rolling",theme:t,user:a,score:n,userId:r,username:s})}).then(e=>e.json()):{}}let f=0,y=!0,m=[];async function u(t,s,c,d,h){if(document.hidden)return;if(!d.broadcaster&&!d.mod||"resetparachute"!==s&&"resetdrop"!==s||location.reload(),(d.broadcaster||d.mod)&&"startroll"===s&&(!function(e){for(let t=e.length-1;t>0;t--){const a=Math.floor(Math.random()*(t+1));[e[t],e[a]]=[e[a],e[t]]}}(m),m.forEach(t=>{!async function t(s,c,p="#ffffff",d,h,f="",y="",m){if(!L[s]){L[s]={};let x=null,b=null,_=null,$=tinycolor(p),U={};try{let t=await fetch(`${e}/accounts/twitch/design?username=${s}`).then(e=>e.json());t&&(U=t.style||{})}catch(e){console.log(e)}if(U.pet&&U.pet.id&&"pet_none"!==U.pet.id&&(a.pets||(a.pets={}),b=U.pet.id.replace("pet_",""),!a.pets[b])){a.pets[b]={path:U.pet.path,minIdle:U.pet.minIdle,maxIdle:U.pet.maxIdle};for(let e=0;e<10;e++){let t=U.pet.path+"_front";Unicorn.Load(t+e,`${n}/assets/pets/${b}/${t}/${t}${e+1}.png`)}}if(f){if(!E[f]){E[f]=!0;var u=`https://static-cdn.jtvnw.net/emoticons/v1/${f}/2.0`;return Unicorn.Load(`emote_${f}`,u),void setTimeout(()=>{delete L[s],t(s,c,p,d,h,f,y,m)},500)}x=Unicorn.AddObject("player_"+s,{type:"circle",scale:{x:1.2,y:1.2},animations:{front:{framerate:4/60,frames:[`emote_${f}`],loop:!0}},x:l(r),y:-100-l(50),z:100,radius:36}),x.endImage=`emote_${f}`,x.endScale=1.2}else if(y){if(!O[y])return O[y]=!0,Unicorn.Load(`emoji_${y}`,y),void setTimeout(()=>{delete L[s],t(s,c,p,d,h,f,y,m)},500);x=Unicorn.AddObject("player_"+s,{type:"circle",scale:{x:1,y:1},animations:{front:{framerate:4/60,frames:[`emoji_${y}`],loop:!0}},x:l(r),y:-100-l(50),z:100,radius:36}),x.endImage=`emoji_${y}`,x.endScale=1}else{if(!a.characters[d])if(U.character&&U.character.id){if(!a.characters[U.character.id]){a.characters[U.character.id]=U.character.path;for(let e=0;e<10;e++){let t=a.characters[U.character.id];Unicorn.Load(`${U.character.id}_${e}`,`${n}/assets/characters/${U.character.id}/${t}_front/${t}_front${e+1}.png`)}}d=U.character.id}else d=a.playable[Math.floor(a.playable.length*Math.random())];if(x=Unicorn.AddObject("player_"+s,{type:"circle",scale:{x:2,y:2},animations:{front:{framerate:4/60,frames:[...Array(10).keys()].map(e=>`${d}_${e}`),loop:!0}},x:l(20),y:-50-l(50),z:100,radius:24}),x.endImage=`${d}_0`,x.endScale=3,"boybear"===d||"girlbear"===d){var g=PIXI.utils.string2hex($.brighten(50).toHexString());x.animations.front.tint=g}}if(b){let e={front:[]};for(let t=0;t<10;t++)Object.keys(e).forEach(o=>{e[o].push(a.pets[b].path+"_"+o+t)});_=Unicorn.AddObject("pet_"+s,{type:"circle",scale:{x:2,y:2},animations:{front:{framerate:4/60,frames:e.front,loop:!0}},x:-1e3,y:-1e3,z:200,radius:16,isStatic:!0}),_.isSensor=!0}let S=Unicorn.AddBacklay("para_"+s,h,{scale:{x:3,y:3},x:50,y:0,z:50});S.scale.x=0,S.scale.y=0,S.anchor.set(.5,.9);let I=Unicorn.AddText("name_"+s,c,-1e3,-1e3,{fontFamily:"Pixeltype",fontSize:40,fontWeight:"bold",fill:p,lineJoin:"round",stroke:$.getLuminance()<.6?"#ffffff":"#000000",strokeThickness:6});I.anchor.set(.5);let A=Unicorn.AddText(s+"_points","",-1e3,-1e3,{fontFamily:"Pixeltype",fontSize:40,fontWeight:"bold",fill:"#ffd700",lineJoin:"round",stroke:"#000000",strokeThickness:6});A.anchor.set(.5);let M=null;b&&(M=Unicorn.AddBacklay("petpara_"+s,h,{scale:{x:1,y:1},x:50,y:0,z:150}),M.scale.x=0,M.scale.y=0,M.anchor.set(.5,.5)),x.restitution=1,x.frictionStatic=0,x.frictionAir=0,x.torque=5+l(10),x.rotationOffset=Math.random()*Math.PI,Unicorn.SetVelocity("player_"+s,l(24)-12,0),L[s]={parachute:S,player:x,pet:_,petPara:M,petType:b,petOffset:10*Math.random(),label:I,scoreLabel:A},m&&(L[s].userId=m.userId,L[s].name=m.displayName||m.username),Unicorn.PlaySound("sfx-parachute-drop",{volume:i}),v&&clearTimeout(v),v=setTimeout(()=>{location.reload()},parseInt(o.cooldown||"90000"))}}(t.username,t.name,t.color,t.message,a.parachutes[l(a.parachutes.length)],t.emote,t.emoji,t.extra)}),m=[]),(d.broadcaster||d.mod)&&"testroll"===s)for(var u=0;u<50;u++)f++,m.push({username:"test"+f,name:"test_"+f,color:h.userColor||"#ffffff",message:c,emote:"",emoji:"",extra:h});if((d.broadcaster||d.mod)&&"droplet"===s){let e=parseInt(c||Math.pow(10,l(6)));for(let t=0;t<5;t++)C(e)}let g=!1;if(o.command&&s===o.command&&(g=!0),o.command||"roll"!==s||(g=!0),p){if(g){y&&o.hideTilDrop&&(y=!1,P.forEach(e=>e.visible=!0),Array.isArray(S)?(S[A].visible=!0,setInterval(()=>{S[A].visible=!1,A=(A+1)%S.length,S[A].visible=!0},60)):S.visible=!0,I&&(I.visible=!0));const e=twemoji.parse(c,{assetType:"png"});!h.messageEmotes&&e.length>0?m.push({username:h.username,name:t,color:h.userColor||"#ffffff",message:c,emote:"",emoji:e[0].url,extra:h}):m.push({username:h.username,name:t,color:h.userColor||"#ffffff",message:c,emote:h.messageEmotes?Object.keys(h.messageEmotes)[0]:"",emoji:"",extra:h})}}else g&&o.oauth&&ComfyJS.Say("PixelHill is disabled in this channel for violating the Terms of Service. To re-enable the game, please contact the PixelPlush team on Discord.")}function g(e,t,a,o,n){document.hidden}function x(e,t,a,o,n){if(!document.hidden&&p)for(let e=0;e<5;e++)C(t)}let b,v=null,_=368,$=0,U=0,S=null,I=null,A=0,L={},M=0,w="",E={},O={},P=[],j=[],T=0;function z(e,t,a,o,n,r=""){T++;let s=Math.min(Math.max(1,n),100);Unicorn.AddParticles("Splash_"+T,{blendMode:PIXI.BLEND_MODES.DEFAULT,shape:"cone",angle:-Math.PI/2,spread:Math.PI/2,startColor:e,endColor:t,intensity:s,minSpeed:.05,maxSpeed:.25,gravityX:0,gravityY:3.5,fadeOut:!0,decay:1,image:r||void 0},a,o),function(e,t=2e3){setTimeout(()=>{Unicorn.RemoveParticles(e)},t)}("Splash_"+T,150)}function k(e,t,o,n=""){const r=a.target_boosh_scale||2;a.target_boosh.forEach((a,o)=>{for(let a=0;a<l(5);a++){T++;let o=Unicorn.AddBacklay("boosh_"+T,"target_boosh"+a,e,t+10,{scale:{x:r,y:r}});o.zIndex=11,o.vX=l(50)-25,o.vY=-350+l(100),o.anchor.set(.5),j.push(o)}})}async function C(e){if(!o.droplets)return;T++;let t=null,n=0;n=e<100?0:e<1e3?1:e<5e3?2:e<1e4?3:e<1e5?4:5;let s=3;a.dropletSizes&&(s*=a.dropletSizes[n]);let i=a.droplets[n];Array.isArray(a.droplets[n])&&(i=a.droplets[n][l(a.droplets[n].length)]),t=Unicorn.AddObject("droplet_"+T,{type:"circle",sprite:i,scale:{x:s,y:s},x:l(r),y:-100-l(50),z:100,radius:n/5*4+20}),t.restitution=1,t.friction=.5*(5-n),t.frictionStatic=0,t.frictionAir=0,t.torque=-1+l(2),t.rotationOffset=Math.random()*Math.PI,Unicorn.SetVelocity("droplet_"+T,l(24)-12,0),setTimeout(()=>{Unicorn.RemoveObject(t.label)},3e4)}function B(){if(PIXI.settings.SCALE_MODE=PIXI.SCALE_MODES.NEAREST,Unicorn.Load("map",`${n}/assets/${a.bg}.png`),!o.overlay){var e=Unicorn.AddBacklay("map","map",0,s-1080);e.scale.x=3,e.scale.y=3}if(Array.isArray(a.target)){a.target.map((e,t)=>Unicorn.Load("target"+t,`${n}/assets/${e}.png`))}else{Unicorn.Load("target",`${n}/assets/${a.target}.png`)}a.target_front&&Unicorn.Load("target_front",`${n}/assets/${a.target_front}.png`),a.target_boosh&&a.target_boosh.forEach((e,t)=>{Unicorn.Load("target_boosh"+t,`${n}/assets/${e}.png`)}),Unicorn.Load("star",`${n}/assets/icons/star.png`),b=Unicorn.AddOverlay("star","star",-1e3,-1e3,{scale:{x:3,y:3}}),b.anchor.set(.5),a.parachutes.forEach(e=>Unicorn.Load(e,`${n}/assets/${e}.png`)),Object.keys(a.characters).forEach(e=>{for(let t=0;t<10;t++){let o=a.characters[e];Unicorn.Load(`${e}_${t}`,`${n}/assets/characters/${e}/${o}_front/${o}_front${t+1}.png`)}}),a.clouds.forEach(e=>Unicorn.Load(e,`${n}/assets/${e}.png`)),a.droplets.forEach(e=>{Array.isArray(e)?e.forEach(e=>Unicorn.Load(e,`${n}/assets/${e}.png`)):Unicorn.Load(e,`${n}/assets/${e}.png`)}),a.target_sound&&Unicorn.Load("sfx-target-drop",`${n}/assets/${a.target_sound}`),Unicorn.Load("sfx-parachute-drop",`${n}/assets/${a.drop_sound}`),Unicorn.Load("sfx-parachute-flap",`${n}/assets/${a.parachute_sound}`);const t=["game-hill/segment1","game-hill/segment2","game-hill/segment3","game-hill/segment4","game-hill/segment5","game-hill/segment6","game-hill/segment7"];t.forEach((e,t)=>{Unicorn.Load(`ground_segment_${t}`,`https://www.pixelplush.dev/assets/${e}.png`)}),Unicorn.AddObject("WallLeft",{type:"rectangle",x:-200,y:0,width:400,height:2*s,isStatic:!0}).sprite.visible=!1,Unicorn.AddObject("WallRight",{type:"rectangle",x:r+200,y:0,width:400,height:2*s,isStatic:!0}).sprite.visible=!1,Unicorn.AddObject("WallBottom",{type:"rectangle",x:.5*r,y:s+100,width:r,height:200,isStatic:!0}).sprite.visible=!1;const i=1.1*s/r;let c=0,p=0,d=[{x:0,y:100}];for(let e=30;e<r;e+=30){let a=e*i-40+l(50),o=Math.atan2(a-p,30),n=Math.sqrt((a-p)**2+900);d.push({x:e,y:100+a});Unicorn.AddObject("Ground_"+e,{type:"rectangle",x:.5*(e-c)+c,y:100+.5*(a-p)+p,width:n,height:20,angle:o,isStatic:!0,color:3355443}).sprite.visible=!1;let r=Unicorn.AddOverlay("ground_segment_"+e,`ground_segment_${l(t.length)}`,.5*(e-c)+c,100+.5*(a-p)+p,{scale:{x:n/50,y:n/50}});r.rotation=o,r.anchor.set(.5,1),c=e,p=a}d.push({x:0,y:s+100});var h=new PIXI.Graphics;h.beginFill(16777215),h.drawPolygon(d.map(e=>new PIXI.Point(e.x,e.y))),h.endFill(),groupWorld.addChild(h),Matter.Events.on(physics,"beforeUpdate",(function(e){})),Matter.Events.on(physics,"afterUpdate",(function(e){for(var t in L)L[t].pet&&(L[t].pet.angle=L[t].player.angle,L[t].pet.position.x=Math.max(10,Math.min(r-10,L[t].player.position.x+L[t].petOffset)),L[t].pet.position.y=L[t].player.position.y+10)}))}function F(e,t){for(var n in L)if(L[n].player)if(L[n].isLanded){let e=n===w?1:.3;L[n].end.alpha=L[n].label.alpha=e,L[n].pet&&(L[n].petEnd.alpha=e),L[n].scoreLabel.tint=L[n].label.tint=n===w?16777215:3355443,n===w?(L[n].end.zIndex=L[n].scoreLabel.zIndex=L[n].label.zIndex=9e3,L[n].pet&&(L[n].pet.zIndex=9001),L[n].label.position.x=L[n].player.position.x,L[n].label.position.y=L[n].player.position.y-80,L[n].scoreLabel.position.x=L[n].label.position.x+15,L[n].scoreLabel.position.y=L[n].label.position.y-30,L[n].label.style.fontSize=46,L[n].scoreLabel.style.fontSize=46,b.x=L[n].scoreLabel.x-L[n].scoreLabel.width/2-15,b.y=L[n].scoreLabel.y-5):(L[n].label.position.x=L[n].player.position.x,L[n].label.position.y=L[n].player.position.y-60,L[n].scoreLabel.position.y=L[n].label.position.y-30,L[n].scoreLabel.alpha=0,L[n].label.style.fontSize=40,L[n].scoreLabel.style.fontSize=40)}else{if(L[n].pet&&(L[n].pet.position.x=Math.max(20,Math.min(r-20,L[n].player.position.x+L[n].petOffset)),L[n].pet.position.y=L[n].player.position.y+20,L[n].petPara.position.x=L[n].pet.position.x,L[n].petPara.position.y=L[n].pet.position.y-30),L[n].player.position.y>s-46-50+(a.target_y_offset||0)){L[n].isLanded=!0,L[n].parachute.scale.x=L[n].parachute.scale.y=0,L[n].pet&&(L[n].petPara.scale.x=L[n].petPara.scale.y=0);let e=Unicorn.AddBacklay("end_"+n,L[n].player.endImage,L[n].player.position.x,L[n].player.position.y,{scale:{x:L[n].player.endScale,y:L[n].player.endScale}});if(L[n].player.animations&&(e.tint=L[n].player.animations.front.tint),e.anchor.set(.5),e.zIndex=20,L[n].player.isStatic=!0,L[n].score=100*Math.max(0,_/2-Math.abs($-L[n].player.position.x))/(_/2),e.alpha=L[n].score>0?1:.3,L[n].end=e,L[n].pet){let e=Unicorn.AddBacklay("petend_"+n,`${L[n].petType}_front0`,L[n].pet.position.x,L[n].pet.position.y,{scale:{x:3,y:3}});L[n].pet.animations&&(e.tint=L[n].pet.animations.front.tint),e.anchor.set(.5),e.zIndex=30,L[n].pet.isStatic=!0,e.alpha=L[n].score>0?1:.3,L[n].petEnd=e}if(L[n].score>0){if(a.target_particles&&z(a.target_particles[0],a.target_particles[1],L[n].player.position.x,L[n].player.position.y+40,10),a.target_boosh&&k(L[n].player.position.x,L[n].player.position.y+40),a.target_sound&&Unicorn.PlaySound("sfx-target-drop",{volume:i}),L[n].scoreLabel.x=L[n].label.position.x,L[n].scoreLabel.y=L[n].label.position.y-30,L[n].scoreLabel.text=L[n].score.toFixed(2),o.messageFormat){let e=o.messageFormat.replace("USERNAME",L[n].name).replace("POINTS",L[n].score.toFixed(2)).replace("SHORTPTS",Math.floor(L[n].score));setTimeout(()=>{ComfyJS.Say(e)},5e3)}n.startsWith("test_")||h(L[n].name,L[n].score.toFixed(2),L[n].userId,n)}L[n].score>M&&(M=L[n].score,w=n),L[n].label.alpha=L[n].score>0?1:.3,Unicorn.RemoveObject(L[n].player.label),Unicorn.RemoveBacklay("para_"+n),L[n].pet&&(Unicorn.RemoveObject(L[n].pet.label),Unicorn.RemoveBacklay("petpara_"+n))}else L[n].player.position.y<.5*-s||(L[n].parachute.scale.x=L[n].parachute.scale.y=0,L[n].pet&&(L[n].petPara.scale.x=L[n].petPara.scale.y=0));L[n].label.position.x=L[n].player.position.x,L[n].label.position.y=L[n].player.position.y-60}P.forEach((e,a)=>{e.x-=t*e.speed,e.x+e.width/2<=0&&(e.x=r+e.width/2,e.y=l(500),e.speed=.01+.1*Math.random(),e.zIndex=e.speed)}),j.forEach(e=>{(e.vY<0||e.y<s-20)&&(e.x+=t/1e3*e.vX,e.y+=t/1e3*e.vY,e.vY<20&&(e.vY+=t/1e3*200))})}